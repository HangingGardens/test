import{_ as J,d as K,b as m,e as _,g as o,t as a,F as C,s as Q,G as d,A as ue,an as me,O as pe,f as fe,B as he,ag as T,a as c,D as ve,o as _e,E as b,h as i,H as p,k as P,M as ge,j as z,P as H,T as W,L as u,W as A,ac as be}from"./index-005617de.js";import{A as we}from"./AddressInfo-dec333d8.js";import{_ as ye}from"./mall-9e8f333c.js";import{O as ke}from"./OrderGoods-8acf48f6.js";import{q as xe}from"./address-9b04e0e1.js";import{e as Ae,p as Ce,d as $e}from"./order-e22f60cf.js";import{u as Ie}from"./useSelectAddress-cd186f38.js";import{c as Oe}from"./cart-efba1c23.js";import"./MCOIN-e82bbfaf.js";const Re={class:"flex-start mt-2.5"},Se=o("img",{src:ye,class:"w-4 mr-1"},null,-1),Ne=K({props:{orderInfo:{type:null,required:!0}},emits:["changeNumber"],setup($,{emit:I}){return(g,O)=>(m(),_(C,null,[o("div",Re,[Se,o("div",null,a($.orderInfo.stores.storeName||"-"),1)]),(m(!0),_(C,null,Q($.orderInfo.goods,(f,M)=>(m(),_("div",{class:"bg-white mt-2.5 rounded-xl p-2.5",key:f.id},[d(ke,{goods:f,number:f.number,class:"mb-2.5 last:mb-0",onChangeNumber:w=>I("changeNumber",f,w)},null,8,["goods","number","onChangeNumber"])]))),128))],64))}}),Be=J(Ne,[["__file","/Users/wangkeai/work/xueyan/mai/flashmall-dapp/src/view/order/components/OrderGoodsCartBox.vue"]]);const Le={key:0,class:"p-2.5"},Ve={class:"text-xl font-semibold"},Ge={class:"bg-white mt-2.5 rounded-xl p-2.5 flex items-center justify-between gap-2"},Te={class:"flex-1"},Me=["onClick"],De={class:"bg-white mt-2.5 rounded-xl p-2.5"},Ee={class:"flex items-baseline justify-between mt-1"},je={class:"text-right"},qe={class:"text-base font-semibold"},Ue={class:"opacity-60"},Fe={class:"bg-white mt-2.5 rounded-xl p-2.5"},Pe={class:"flex items-baseline justify-between mt-1"},ze={class:"text-right"},He={class:"text-base font-semibold"},We={class:"opacity-60"},Je={class:"flex flex-col items-center my-[50px]"},Ke={class:"p-2.5 pb-[150px]"},Qe={class:"relative text-center mb-2.5"},Xe=K({setup($){const{t:I}=ue(),{loadingToggle:g}=be(),{getAddress:O,setAddress:f}=Ie(),{submit:M}=me(),w=pe(),{tradeContributeSelfRate:X}=fe(),R=he(),[S,N]=T(!1),[Y,Z]=T(!0),[D,y]=T(!1),B=c([]),h=c(),k=c([]),E=c(0),L=c({remark:""}),j=c(0),ee=c(0),te=ve(()=>E.value>j.value),se=async()=>{if(O()){h.value=O(),f(null);return}const e=await xe();!e.success||(B.value=e.data,h.value=B.value.find(t=>t.isDefault===1)||B.value[0])},q=async()=>{const e=await(await w).allowance(H.order);E.value=e.result},oe=async()=>{y(!0),(await(await w).approve(H.order)).success&&await q(),y(!1)},ae=async()=>{const e=await $e({type:2});if(!e.success){setTimeout(()=>{R.back()},1500);return}h.value=e.data.defaultAddress,k.value=(e.data.ordersInfos||[]).map(t=>{let r=0,s=0;return t.orderGoods.forEach(l=>{r+=l.price*l.number,s+=l.price*l.number*(l.discountRatio/100),ee.value+=s}),{...t,goods:t.orderGoods,totalAmount:r||0,integral:s||0,remark:""}}),j.value=e.data.totalAmount||0},re=async(e,t)=>{g(!0);const r=await Oe({goodsId:e.goodsId,number:t});g(!1),r.success&&(e.number=t)},ne=async e=>{L.value=e,N(!0)},le=async()=>{if(!h.value)return W(I("order.setAddress"));y(!0);try{const e=(k.value||[]).map(x=>({postscript:x.remark,storeId:x.stores.id})),t=await Ae({type:2,addressId:h.value.id,postscripts:e});if(!t.success)return;const{allOrderId:r,merchants:s,discounts:l,amounts:G}=t.data,v=await M(s,l,G);v.success||W(v.result.reason||"Fail");const n=await Ce({allOrderId:r,hash:v.result.hash});await v.result.wait()}finally{y(!1),setTimeout(()=>{R.back()},1500)}},V=c(1),ie=async()=>{V.value=await X()},U=e=>{let t=0,r=0;return e.orderGoods.forEach(s=>{t+=s.price*s.number,r+=s.price*s.number*(s.discountRatio/100)}),{totalAmount:t,integral:r}},F=()=>{let e=0,t=0;return k.value.forEach(r=>{r.orderGoods.forEach(s=>{e+=s.price*s.number,t+=s.price*s.number*(s.discountRatio/100)})}),{totalAmount:e,integral:t}},de=async()=>{g(!0),ae(),ie(),await q(),await se(),g(!1),Z(!1)},ce=e=>{R.push(e)};return _e(()=>{de()}),(e,t)=>{const r=b("van-icon"),s=b("h"),l=b("VanButton"),G=b("van-field"),v=b("van-popup");return i(Y)?z("v-if",!0):(m(),_("div",Le,[o("header",Ve,a(e.$t("order.submitOrder")),1),d(we,{class:"mt-2.5",defaultAddress:h.value,onClick:t[0]||(t[0]=n=>ce("/userAddress"))},null,8,["defaultAddress"]),(m(!0),_(C,null,Q(k.value,(n,x)=>(m(),_(C,{key:x},[d(Be,{orderInfo:n,onChangeNumber:re},null,8,["orderInfo"]),o("div",Ge,[o("div",Te,a(e.$t("order.remark")),1),o("div",{class:"flex-1 text-right line-clamp-1 opacity-60 whitespace-nowrap",onClick:Ye=>ne(n)},[u(a(n.remark?n.remark:e.$t("order.noRemark"))+" ",1),d(r,{name:"arrow"})],8,Me)]),o("div",De,[z(" <h>{{ $t('order.priceDetail') }}</h> "),o("div",Ee,[d(s,{class:"opacity-60"},{default:p(()=>[u(a(e.$t("order.total")),1)]),_:1}),o("div",je,[o("div",qe,a(i(A)(U(n).totalAmount||0))+"Mcoin",1),o("div",Ue,a(e.$t("order.getContribution",{num:i(A)(U(n).integral*V.value||0)})),1)])])])],64))),128)),o("div",Fe,[d(s,null,{default:p(()=>[u(a(e.$t("order.priceDetail")),1)]),_:1}),o("div",Pe,[d(s,{class:"opacity-60"},{default:p(()=>[u(a(e.$t("order.total")),1)]),_:1}),o("div",ze,[o("div",He,a(i(A)(F().totalAmount||0))+"Mcoin",1),o("div",We,a(e.$t("order.getContribution",{num:i(A)(F().integral*V.value||0)})),1)])])]),o("div",Je,[i(te)?(m(),P(l,{key:1,class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",loading:i(D),onClick:le},{default:p(()=>[u(a(e.$t("common.pay")),1)]),_:1},8,["loading"])):(m(),P(l,{key:0,class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",loading:i(D),onClick:oe},{default:p(()=>[u(a(e.$t("common.approve")),1)]),_:1},8,["loading"]))]),d(v,{show:i(S),"onUpdate:show":t[4]||(t[4]=n=>ge(S)?S.value=n:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:p(()=>[o("div",Ke,[o("div",Qe,[u(a(e.$t("order.submitOrder"))+" ",1),o("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:t[1]||(t[1]=n=>i(N)(!1))},[d(r,{name:"cross"})])]),d(G,{modelValue:L.value.remark,"onUpdate:modelValue":t[2]||(t[2]=n=>L.value.remark=n),rows:"5",autosize:"",type:"textarea",maxlength:"200",placeholder:e.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"])]),d(l,{class:"mb-[50px] inline-block btn-orange btn-shadow w-[150px] h-[40px] text-white",onClick:t[3]||(t[3]=n=>i(N)(!1))},{default:p(()=>[u(a(e.$t("common.confirm")),1)]),_:1})]),_:1},8,["show"])]))}}}),it=J(Xe,[["__scopeId","data-v-12554aa4"],["__file","/Users/wangkeai/work/xueyan/mai/flashmall-dapp/src/view/order/SubmitOrderCart.vue"]]);export{it as default};
