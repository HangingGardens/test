import{_ as F,d as j,u as z,A as G,O as H,f as J,C as y,m as W,ae as K,w as Q,D as X,o as Y,E as c,e as Z,G as r,g as s,t as n,h as a,H as d,L as m,k,M as ee,aa as te,P as B,T as ae,b as h,i as oe,W as se,p as ne,l as le}from"./index-dd2b66f1.js";import{_ as re}from"./MCOIN-c941fc3b.js";import{_ as ie}from"./avatarBig-f2d754bd.js";import{B as ce}from"./BackIcon-54c2e114.js";import{q as de}from"./bill-e0dc10f4.js";const S=p=>(ne("data-v-4c74b6a1"),p=p(),le(),p),me={class:"bg-gradient-to-b from-color4 to-color9 px-4 pt-4"},pe={class:"mt-6 text-lg bg-white px-9 py-3.5 rounded-t-xl"},ue={class:"font-bold"},be={class:"text-[#D1C2A7]"},we={class:"py-6 rounded-b-xl linear-bg text-center px-10"},fe=S(()=>s("img",{src:re,class:"w-6 h-6 absolute top-0 right-0"},null,-1)),_e={class:"text-[#B4B4B4] mt-5"},he={class:"border-b border-solid border-[#e1e1e1] text-3xl relative mt-2.5 pb-5"},ge={class:"bg-white w-full mt-2.5 rounded-xl p-2.5 flex items-center justify-between text-xs"},ve=S(()=>s("img",{class:"bottom-img absolute bottom-0 left-4",src:ie},null,-1)),xe={class:"p-2.5 pb-[150px] remark-bpx"},ye={class:"relative text-center mb-2.5"},ke=j({setup(p){z();const{t:C}=G(),u=H(),{merchantDiscounts:A,tradeContributeSelfRate:V,trade:$,pointBalances:R}=J(),[b,w]=y(!1),[g,i]=y(!1),e=W({storeAddress:"",amount:null,balance:null,ratio:0,remark:null,hash:"",pointSelfRate:0,allowance:0,walletBalance:null,pointBalance:0}),P=K(),D=async t=>{e.ratio=await A(t)},I=t=>{t=JSON.parse(t),e.storeAddress=t.address,D(t.address)},v=async()=>{e.walletBalance=await(await u).balanceOf(),e.pointBalance=+await R(),e.balance=+e.walletBalance+ +te(e.pointBalance).times(.9)},M=async()=>{e.pointSelfRate=await V()};Q(()=>P.query.params,t=>{try{I(t)}catch(o){console.log(o)}},{immediate:!0,deep:!0});const T=X(()=>e.allowance>e.amount),f=async()=>{const t=await(await u).allowance(B.flashMall);e.allowance=t.result},N=async()=>{i(!0),(await(await u).approve(B.flashMall)).success&&await f(),i(!1)},U=async()=>{i(!0);try{const t=await $(e.storeAddress,e.amount);q(t.result.hash),await t.result.wait(),ae.success(C("common.paySucess")),setTimeout(()=>{e.amount=null,v(),f()},1500)}finally{i(!1)}},q=async t=>{if(!(await de({storeAddress:e.storeAddress,amount:e.amount,remark:e.remark,hash:t})).success)return i(!1)};return Y(()=>{v(),M(),f()}),(t,o)=>{const L=c("VanField"),x=c("van-icon"),_=c("VanButton"),O=c("van-field"),E=c("van-popup");return h(),Z("div",me,[r(ce,{class:"text-white/90"}),s("header",pe,[s("div",ue,n(a(oe)(a(e).storeAddress)),1),s("div",be,n(t.$t("common.rebate")+a(e).ratio*100)+"%",1)]),s("div",we,[s("div",null,n(t.$t("bill.payAmount")),1),r(L,{modelValue:a(e).amount,"onUpdate:modelValue":o[0]||(o[0]=l=>a(e).amount=l),placeholder:a(e).balance,"input-align":"center",type:"number",class:"border-b border-solid border-[#e1e1e1] text-3xl relative mt-7"},{"right-icon":d(()=>[fe]),_:1},8,["modelValue","placeholder"]),s("div",_e,n(t.$t("order.preScore")),1),s("div",he,n(a(se)(a(e).amount*a(e).ratio*a(e).pointSelfRate)),1),s("div",ge,[s("div",null,n(t.$t("order.remark")),1),s("div",{class:"flex-1 text-right line-clamp-1 text-[#D1C2A7]",onClick:o[1]||(o[1]=l=>a(w)(!0))},[m(n(a(e).remark?a(e).remark:t.$t("order.noRemark"))+" ",1),r(x,{name:"arrow"})])]),a(T)?(h(),k(_,{key:1,class:"block w-full mt-1 h-[40px] btn-orange btn-shadow text-white",onClick:U,loading:a(g),disabled:!a(e).amount||+a(e).amount>+a(e).balance},{default:d(()=>[m(n(t.$t("common.pay")),1)]),_:1},8,["loading","disabled"])):(h(),k(_,{key:0,class:"block w-full mt-1 h-[40px] btn-orange btn-shadow text-white",onClick:N,loading:a(g)},{default:d(()=>[m(n(t.$t("common.approve")),1)]),_:1},8,["loading"]))]),ve,r(E,{show:a(b),"onUpdate:show":o[5]||(o[5]=l=>ee(b)?b.value=l:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:d(()=>[s("div",xe,[s("div",ye,[m(n(t.$t("common.pay"))+" ",1),s("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:o[2]||(o[2]=l=>a(w)(!1))},[r(x,{name:"cross"})])]),r(O,{modelValue:a(e).remark,"onUpdate:modelValue":o[3]||(o[3]=l=>a(e).remark=l),rows:"5",autosize:"",type:"textarea",maxlength:"200",placeholder:t.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"])]),r(_,{class:"mb-[50px] inline-block btn-orange btn-shadow w-[150px] h-[40px] text-white",onClick:o[4]||(o[4]=l=>a(w)(!1))},{default:d(()=>[m(n(t.$t("common.confirm")),1)]),_:1})]),_:1},8,["show"])])}}}),$e=F(ke,[["__scopeId","data-v-4c74b6a1"],["__file","/Users/wangkeai/work/xueyan/mai/flashmall-dapp/src/view/bill/Pay.vue"]]);export{$e as default};
