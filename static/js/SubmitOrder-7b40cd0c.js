import{_ as F,d as P,b as k,e as E,g as t,t as o,G as n,F as de,A as ce,an as ue,O as me,f as pe,ae as fe,B as ve,ag as R,a as r,D as S,o as ge,E as h,h as a,L as c,H as u,k as M,M as he,j as we,W as be,P as U,T as j,ac as _e}from"./index-7bcb6f7b.js";import{A as ye}from"./AddressInfo-789da4ce.js";import{_ as xe}from"./mall-9e8f333c.js";import{O as ke}from"./OrderGoods-47eb09a6.js";import{q as $e}from"./address-95b5c638.js";import{b as Ce}from"./goods-217595dc.js";import{c as Ae,d as Ie,e as Ne,p as Re}from"./order-1ae60e86.js";import{u as Se}from"./useSelectAddress-cd186f38.js";import"./MCOIN-407788ba.js";const Be={class:"flex-start mt-2.5"},Oe=t("img",{src:xe,class:"w-4 mr-1"},null,-1),Le={class:"bg-white mt-2.5 rounded-xl p-2.5"},Ve=P({props:{orderInfo:{type:null,required:!0},number:{type:Number,required:!0}},emits:["changeNumber"],setup(w,{emit:$}){const b=m=>{$("changeNumber",m)};return(m,B)=>(k(),E(de,null,[t("div",Be,[Oe,t("div",null,o(w.orderInfo.stores.storeName||"-"),1)]),t("div",Le,[n(ke,{goods:w.orderInfo.goods,number:w.number,class:"mb-2.5 last:mb-0",onChangeNumber:b},null,8,["goods","number"])])],64))}}),De=F(Ve,[["__file","/Users/wangkeai/work/xueyan/mai/flashmall-dapp/src/view/order/components/OrderGoodsBox.vue"]]);const Ge={key:0,class:"p-2.5"},qe={class:"text-xl font-semibold"},Te={class:"bg-white mt-2.5 rounded-xl p-2.5 flex items-center justify-between gap-2"},Me={class:"flex-1"},Ue={class:"bg-white mt-2.5 rounded-xl p-2.5"},je={class:"flex items-baseline justify-between mt-1"},Fe={class:"text-right"},Pe={class:"text-base font-semibold"},Ee={class:"opacity-60"},ze={class:"flex flex-col items-center my-[50px]"},He={class:"p-2.5 pb-[150px]"},We={class:"relative text-center mb-2.5"},Je=P({setup(w){const{t:$}=ce(),{loadingToggle:b}=_e(),{getAddress:m,setAddress:B}=Se(),{submit:z}=ue(),O=me(),{merchantDiscounts:H,tradeContributeSelfRate:W}=pe(),J=fe(),L=ve(),[C,A]=R(!1),[K,Q]=R(!0),[V,_]=R(!1),I=r([]),p=r(),l=r(),D=r(0),f=r(""),v=r(1),N=S(()=>{var e;return((e=l.value)==null?void 0:e.goods.price)*v.value}),X=S(()=>be(l.value.goods.discountRatio/100*N.value*q.value)),Y=S(()=>D.value>N.value),Z=async()=>{if(m()){p.value=m(),B(null);return}const e=await $e();!e.success||(I.value=e.data,p.value=I.value.find(s=>s.isDefault===1)||I.value[0])},ee=async()=>{const e=await Ce(+J.query.id);e.success,l.value=e.data},G=async()=>{const e=await(await O).allowance(U.order);D.value=e.result},te=async()=>{_(!0),(await(await O).approve(U.order)).success&&await G(),_(!1)},se=e=>{e<1?v.value=1:v.value=e},oe=async()=>{if(!p.value)return j($("order.setAddress"));_(!0);try{await Ae({goodsId:l.value.goods.id,number:v.value}),await Ie({type:1});const e=await Ne({type:1,addressId:p.value.id,postscripts:[{postscript:f.value,storeId:l.value.stores.id}]});if(!e.success)return;const{allOrderId:s,merchants:y,discounts:x,amounts:g}=e.data,i=await z(y,x,g);i.success||j(i.result.reason||"Fail"),console.log(i);const T=await Re({allOrderId:s,hash:i.result.hash});await i.result.wait()}finally{_(!1),L.back()}},ae=r(0),q=r(0),ne=async()=>{ae.value=await H(l.value.stores.merchant)},re=async()=>{q.value=await W()},le=async()=>{b(!0),await Z(),await ee(),await G(),ne(),re(),b(!1),Q(!1)},ie=e=>{L.push(e)};return ge(()=>{le()}),(e,s)=>{const y=h("van-icon"),x=h("h"),g=h("VanButton"),i=h("van-field"),T=h("van-popup");return a(K)?we("v-if",!0):(k(),E("div",Ge,[t("header",qe,o(e.$t("order.submitOrder")),1),n(ye,{class:"mt-2.5",defaultAddress:p.value,onClick:s[0]||(s[0]=d=>ie("/userAddress"))},null,8,["defaultAddress"]),n(De,{orderInfo:l.value,number:v.value,onChangeNumber:se},null,8,["orderInfo","number"]),t("div",Te,[t("div",Me,o(e.$t("order.remark")),1),t("div",{class:"flex-1 text-right line-clamp-1 opacity-60 whitespace-nowrap",onClick:s[1]||(s[1]=d=>a(A)(!0))},[c(o(f.value?f.value:e.$t("order.noRemark"))+" ",1),n(y,{name:"arrow"})])]),t("div",Ue,[n(x,null,{default:u(()=>[c(o(e.$t("order.priceDetail")),1)]),_:1}),t("div",je,[n(x,{class:"opacity-60"},{default:u(()=>[c(o(e.$t("order.total")),1)]),_:1}),t("div",Fe,[t("div",Pe,o(a(N))+"Mcoin",1),t("div",Ee,o(e.$t("order.getContribution",{num:a(X)})),1)])])]),t("div",ze,[a(Y)?(k(),M(g,{key:1,class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",loading:a(V),onClick:oe},{default:u(()=>[c(o(e.$t("common.pay")),1)]),_:1},8,["loading"])):(k(),M(g,{key:0,class:"btn-orange btn-shadow w-[150px] h-[40px] text-white",loading:a(V),onClick:te},{default:u(()=>[c(o(e.$t("common.approve")),1)]),_:1},8,["loading"]))]),n(T,{show:a(C),"onUpdate:show":s[5]||(s[5]=d=>he(C)?C.value=d:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:u(()=>[t("div",He,[t("div",We,[c(o(e.$t("order.submitOrder"))+" ",1),t("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:s[2]||(s[2]=d=>a(A)(!1))},[n(y,{name:"cross"})])]),n(i,{modelValue:f.value,"onUpdate:modelValue":s[3]||(s[3]=d=>f.value=d),rows:"5",autosize:"",type:"textarea",maxlength:"200",placeholder:e.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"])]),n(g,{class:"mb-[50px] inline-block btn-orange btn-shadow w-[150px] h-[40px] text-white",onClick:s[4]||(s[4]=d=>a(A)(!1))},{default:u(()=>[c(o(e.$t("common.confirm")),1)]),_:1})]),_:1},8,["show"])]))}}}),at=F(Je,[["__scopeId","data-v-78097d38"],["__file","/Users/wangkeai/work/xueyan/mai/flashmall-dapp/src/view/order/SubmitOrder.vue"]]);export{at as default};
